{% comment %}
  This section is used in the search template to render search results.
  For products, it redirects to the collection template with search results.
  For other types (articles, pages), it shows the results inline.
{% endcomment %}

<div class="search-page container mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold mb-6 hidden">{{ 'search.title' | t }}</h1>

  <form action="{{ routes.search_url }}" method="get" role="search" class="mb-8">
    <div class="flex gap-2 w-full md:max-w-2xl">
      <input
        autofocus
        type="search"
        name="q"
        value="{{ search.terms | escape }}"
        placeholder="{{ 'search.placeholder' | t }}"
        class="flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
      >
      <input type="hidden" name="type" value="product,article,page">
      <button type="submit" class="px-6 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700 transition-colors hidden md:block">
        {{ 'search.submit' | t }}
      </button>
    </div>
  </form>

  {% if search.performed %}
    {% # Handle product searches by redirecting to collection template %}
    {% if search.types contains 'product' %}
      {% assign product_results = search.results | where: 'object_type', 'product' %}
      {% if product_results.size > 0 %}
        <div class="mb-8">
          <h2 class="text-2xl font-semibold mb-4 hidden">
            {{ 'search.products_found' | t: count: product_results.size, terms: search.terms }}
          </h2>
          <!-- Search Results Container -->
          <div id="search-products-container" 
               data-search-terms="{{ search.terms | escape }}">
            <!-- Loading State -->
            <div class="loading-spinner">
              <div class="flex flex-col items-center justify-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"></div>
                <p class="mt-4 text-gray-600">{{ 'search.loading_products' | t }}</p>
              </div>
            </div>
          </div>
        </div>
      {% endif %}
    {% endif %}

    {% # Handle other search results (articles, pages) %}
    {% assign other_results = search.results | where: 'object_type', '!=', 'product' %}
    {% if other_results.size > 0 %}
      <div class="mt-12">
        <h2 class="text-2xl font-semibold mb-6">
          {{ 'search.other_results' | t: count: other_results.size }}
        </h2>
        <div class="space-y-6">
          {% for result in other_results %}
            <div class="p-6 bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow">
              <h3 class="text-xl font-medium text-gray-900 mb-2">
                <a href="{{ result.url }}" class="hover:text-primary-600 transition-colors">
                  {{ result.title }}
                </a>
              </h3>
              {% if result.object_type == 'article' %}
                <p class="text-sm text-gray-500 mb-3">
                  {{ result.published_at | time_tag: format: 'date' }}
                  {% if result.tags.size > 0 %}
                    â€¢ {{ result.tags | join: ', ' }}
                  {% endif %}
                </p>
                {% if result.excerpt != blank %}
                  <p class="text-gray-600 mb-3">{{ result.excerpt | strip_html | truncatewords: 30 }}</p>
                {% elsif result.content != blank %}
                  <p class="text-gray-600 mb-3">{{ result.content | strip_html | truncatewords: 30 }}</p>
                {% endif %}
              {% endif %}
              <a href="{{ result.url }}" class="inline-flex items-center text-primary-600 hover:text-primary-800 font-medium">
                {{ 'search.read_more' | t }}
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </a>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if search.results_count == 0 %}
      <div class="text-center py-12">
        <p class="text-xl text-gray-600">{{ 'search.no_results_html' | t: terms: search.terms }}</p>
        <p class="mt-4">
          <a href="{{ routes.all_products_collection_url }}" class="text-primary-600 hover:text-primary-800 font-medium">
            {{ 'search.browse_all_products' | t }}
          </a>
        </p>
      </div>
    {% endif %}
  {% endif %}
</div>

{% schema %}
{
  "name": "Search",
  "settings": [
    {
      "type": "header",
      "content": "Search Settings"
    },
    {
      "type": "text",
      "id": "placeholder_text",
      "label": "Search placeholder text",
      "default": "Search our store..."
    }
  ]
}
{% endschema %}

{% stylesheet %}
  .search-results {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  }
  .search-results .prev,
  .search-results .page,
  .search-results .next {
    grid-column: 1 / -1;
  }
{% endstylesheet %}

{% render 'search-scripts' %}
