{% comment %}
Custom Review Carousel - FIXED v4
- Added "ghost" slides at start and end for proper centering of first/last real slides.
- Adjusted scroll-snap-type for more flexible scrolling.
- Refined JS for active state calculation to ignore ghost slides and ensure correct initial centering.
{% endcomment %}

{% comment %} --- SVG DEFINITIONS --- {% endcomment %}
{%- capture icon_star_filled -%}
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
</svg>
{%- endcapture -%}

{%- capture icon_star_half -%}
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="half_grad_star_{{ section.id }}">
      <stop offset="50%" stop-color="currentColor" />
      <stop offset="50%" stop-color="transparent" />
    </linearGradient>
  </defs>
  <path fill="url(#half_grad_star_{{ section.id }})" stroke="currentColor" stroke-width="2" stroke-linecap="round"
    stroke-linejoin="round"
    d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" />
</svg>
{%- endcapture -%}

{%- capture icon_star_empty -%}
<svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
    stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
</svg>
{%- endcapture -%}

<div id="ReviewSection-{{ section.id }}" class="review-carousel-section"
  style="background-color: {{ section.settings.bg_color }};">
  <div class="review-grid-pattern"></div>

  <div class="page-width">
    {% if section.settings.title != blank %}
    <h2 class="text-3xl font-bold mb-4 text-center uppercase">{{ section.settings.title }}</h2>
    {% endif %}

    <div class="review-carousel-container">
      <div class="review-carousel-track" data-track>


        {% for block in section.blocks %}
        <div class="review-card-slide" {{ block.shopify_attributes }} data-review-slide>
          <div class="review-card-inner">

            {% comment %} Review Image {% endcomment %}
            {% if block.settings.image != blank %}
            <div class="review-image-wrapper">
              <img src="{{ block.settings.image | image_url: width: 600 }}"
                alt="{{ block.settings.image.alt | escape }}" loading="lazy" width="600"
                height="{{ 600 | divided_by: block.settings.image.aspect_ratio | ceil }}" class="review-image">
            </div>
            {% endif %}

            {% comment %} Rating Icons (Stars) {% endcomment %}
            <div class="review-stars">
              {% assign rating = block.settings.rating %}
              {% for i in (1..5) %}
              {% assign threshold = i | minus: 0.5 %}
              <span class="star-icon">
                {% if rating >= i %}
                {{ icon_star_filled }}
                {% elsif rating >= threshold %}
                {{ icon_star_half }}
                {% else %}
                {{ icon_star_empty }}
                {% endif %}
              </span>
              {% endfor %}
            </div>

            {% comment %} Headline {% endcomment %}
            {% if block.settings.heading != blank %}
            <h3 class="review-headline">“{{ block.settings.heading }}”</h3>
            {% endif %}

            {% comment %} Review Text {% endcomment %}
            <div class="review-text">
              {{ block.settings.text }}
            </div>

            {% comment %} Reviewer Name & Verified Badge {% endcomment %}
            <div class="review-author">
              <span class="author-name">{{ block.settings.author | upcase }}</span>
              <span class="verified-badge" title="Verified Buyer">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path
                    d="M9 12L11 14L15 10M21 12C21 16.9706 16.9706 21 12 21C7.02944 21 3 16.9706 3 12C3 7.02944 7.02944 3 12 3C16.9706 3 21 7.02944 21 12Z"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </span>
            </div>

            {% comment %} Optional Product Link {% endcomment %}
            {% if block.settings.product != blank %}
            <div class="review-product-link">
              <a href="{{ block.settings.product.url }}">
                {{ block.settings.product.title }}
              </a>
            </div>
            {% endif %}

          </div>
        </div>
        {% endfor %}


      </div>

      {% comment %} Navigation Buttons {% endcomment %}
      <div class="review-nav-controls">
        <button class="review-nav-btn prev" aria-label="Previous review" data-direction="prev">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
        <button class="review-nav-btn next" aria-label="Next review" data-direction="next">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 18l6-6-6-6" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </button>
      </div>

    </div>
  </div>
</div>

<style>
  /* --- Fonts & Variables --- */
  .review-carousel-section {
    position: relative;
    padding: 60px 20px;
    overflow: hidden;
    font-family: "HelveticaNeue", "Helvetica Neue", Helvetica, Arial, sans-serif;
  }

  /* --- Grid Background Effect --- */
  .review-grid-pattern {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .review-carousel-section .page-width {
    position: relative;
    max-width: 600px;
    margin: 0 auto;
    z-index: 1;
    transition: max-width 0.3s ease;
  }

  /* --- Carousel Container --- */
  .review-carousel-container {
    background: transparent;
    border: none;
    padding: 0;
    text-align: center;
    overflow: hidden;
  }

  .review-carousel-track {
    display: flex;
    overflow-x: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    gap: 20px;
    padding: 30px 20px;
    /* Changed to proximity for smoother, less strict snapping with ghost slides */
    scroll-snap-type: x proximity;
    scrollbar-width: none;
    align-items: stretch;
    position: relative;
  }

  .review-carousel-track::-webkit-scrollbar {
    display: none;
  }

  /* --- Slides --- */
  .review-card-slide {
    min-width: 100%;
    flex: 0 0 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    scroll-snap-align: center;
    transition: transform 0.4s ease, opacity 0.4s ease;
    transform-origin: center center;
  }

  /* Style for ghost slides */
  .review-card-ghost {
    min-width: 100%;
    /* Take up the same space as a real slide */
    background: transparent !important;
    box-shadow: none !important;
    pointer-events: none;
    /* Make sure they don't block interaction */
    visibility: hidden;
    /* Hide them visually */
    flex-shrink: 0;
    /* Ensure they don't shrink */
  }

  /* --- Card Design --- */
  .review-card-inner {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 30px 20px;
    background: #fff;
    box-shadow: 0 4px 15px rgba(74, 111, 255, 0.1);
  }

  /* --- Desktop Specific Styles --- */
  @media screen and (min-width: 750px) {
    .review-carousel-section .page-width {
      max-width: 1400px;
    }

    .review-carousel-track {
      gap: 10px;
    }

    .review-card-slide {
      min-width: 33%;
      flex: 0 0 33%;
      transform: scale(0.85);
      opacity: 0.7;
      /* Inactive state opacity */
      cursor: pointer;
    }

    .review-card-slide.is-active {
      transform: scale(1);
      opacity: 1;
      z-index: 2;
      box-shadow: 0 10px 30px rgba(74, 111, 255, 0.15);
    }

    /* Adjust ghost slide width for desktop to match real slides */
    .review-card-ghost {
      min-width: 33%;
    }
  }

  /* --- Image --- */
  .review-image-wrapper {
    width: 100%;
    margin-bottom: 20px;
    border-radius: 4px;
    overflow: hidden;
  }

  .review-image {
    width: 100%;
    height: auto;
    object-fit: cover;
    aspect-ratio: 1 / 1;
    display: block;
  }

  /* --- Stars --- */
  .review-stars {
    display: flex;
    gap: 5px;
    margin-bottom: 15px;
    color: #000;
  }

  .star-icon svg {
    width: 20px;
    height: 20px;
    display: block;
  }

  /* --- Content --- */
  .review-headline {
    font-size: 18px;
    font-weight: 800;
    text-transform: uppercase;
    line-height: 1.3;
    margin: 0 0 15px 0;
    color: #111;
    padding: 0 10px;
  }

  .review-text {
    font-size: 14px;
    line-height: 1.6;
    color: #444;
    margin-bottom: 20px;
    max-width: 90%;
  }

  .review-author {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    font-weight: 700;
    font-size: 13px;
    color: #000;
    margin-bottom: 10px;
  }

  .verified-badge {
    color: #000;
    display: flex;
    align-items: center;
  }

  .review-product-link {
    margin-top: 5px;
    font-size: 12px;
  }

  .review-product-link a {
    font-weight: bold;
    text-decoration: underline;
    border-bottom: 1px solid transparent;
    transition: border 0.2s;
  }

  .review-product-link a:hover {
    border-bottom: 1px solid #4A6FFF;
  }

  /* --- Controls --- */
  .review-nav-controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    padding-bottom: 10px;
    margin-top: 20px;
  }

  .review-nav-btn {
    background: #eee;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background 0.2s, color 0.2s;
    color: #333;
  }

  .review-nav-btn:hover {
    background: #ddd;
    color: #000;
  }
</style>

<script>
  (function () {
    const sectionId = "ReviewSection-{{ section.id }}";
    let isScrolling;

    function initReviewCarousel() {
      const container = document.getElementById(sectionId);
      if (!container) return;

      const track = container.querySelector('[data-track]');
      if (!track) return;

      // Clean up any existing clones from previous inits
      track.querySelectorAll('.is-clone').forEach(el => el.remove());

      // Get real slides (exclude any ghosts if they still exist)
      const realSlides = Array.from(track.querySelectorAll('.review-card-slide:not(.review-card-ghost):not(.is-clone)'));
      if (realSlides.length < 2) return;

      // Clone Configuration
      const cloneCount = 3; // Sufficient for desktop view (3 items) + buffer

      // Create Clones
      const clonesStart = [];
      const clonesEnd = [];

      // Clone last N slides for the start (Prepend)
      for (let i = realSlides.length - cloneCount; i < realSlides.length; i++) {
        if (realSlides[i]) {
          const clone = realSlides[i].cloneNode(true);
          clone.classList.add('is-clone');
          clone.removeAttribute('data-review-slide');
          clone.setAttribute('aria-hidden', 'true');
          clonesStart.push(clone);
        }
      }

      // Clone first N slides for the end (Append)
      for (let i = 0; i < cloneCount; i++) {
        if (realSlides[i]) {
          const clone = realSlides[i].cloneNode(true);
          clone.classList.add('is-clone');
          clone.removeAttribute('data-review-slide');
          clone.setAttribute('aria-hidden', 'true');
          clonesEnd.push(clone);
        }
      }

      // Insert Clones
      // Reverse clonesStart so they are inserted in the correct order (e.g. 3, 4, 5 -> 3 is first, 5 is last before real slides)
      clonesStart.reverse().forEach(clone => track.insertBefore(clone, track.firstChild));
      clonesEnd.forEach(clone => track.appendChild(clone));

      // Re-query all slides in order
      const allSlides = Array.from(track.children);

      // State
      let currentIndex = cloneCount; // Start at the first real slide

      // Helper: Scroll to specific index
      function scrollToSlide(index, behavior = 'smooth') {
        const slide = allSlides[index];
        if (!slide) return;

        const trackWidth = track.clientWidth;
        const slideLeft = slide.offsetLeft;
        const slideWidth = slide.offsetWidth;
        const centerPos = slideLeft - (trackWidth / 2) + (slideWidth / 2);

        if (behavior === 'instant') {
          track.style.scrollBehavior = 'auto';
          track.scrollTo({ left: centerPos });
          // Restore CSS scroll-behavior after a brief moment
          setTimeout(() => {
            track.style.scrollBehavior = '';
          }, 50);
        } else {
          track.style.scrollBehavior = 'smooth';
          track.scrollTo({ left: centerPos, behavior: 'smooth' });
        }
        
        // Update active class visually
        allSlides.forEach(s => s.classList.remove('is-active'));
        slide.classList.add('is-active');
      }

      // Initial Setup
      setTimeout(() => {
        scrollToSlide(currentIndex, 'instant');
      }, 50);

      // Scroll Loop Logic
      function checkInfiniteLoop() {
        const trackCenter = track.scrollLeft + (track.clientWidth / 2);
        
        // Find visually closest slide
        let closestIndex = -1;
        let minDistance = Infinity;

        allSlides.forEach((slide, index) => {
          const slideCenter = slide.offsetLeft + (slide.offsetWidth / 2);
          const dist = Math.abs(trackCenter - slideCenter);
          if (dist < minDistance) {
            minDistance = dist;
            closestIndex = index;
          }
        });

        // Teleport if in clone zone
        if (closestIndex !== -1) {
          let newIndex = closestIndex;
          let didTeleport = false;

          if (closestIndex < cloneCount) {
            // In start clones -> Jump to end real slides
            newIndex = closestIndex + realSlides.length;
            didTeleport = true;
          } else if (closestIndex >= allSlides.length - cloneCount) {
            // In end clones -> Jump to start real slides
            newIndex = closestIndex - realSlides.length;
            didTeleport = true;
          }

          if (didTeleport) {
            currentIndex = newIndex;
            scrollToSlide(newIndex, 'instant');
          } else {
            currentIndex = closestIndex;
            // Ensure active class is correct if we didn't teleport
            allSlides.forEach(s => s.classList.remove('is-active'));
            if (allSlides[currentIndex]) allSlides[currentIndex].classList.add('is-active');
          }
        }
      }

      // Scroll Listener
      track.addEventListener('scroll', () => {
        clearTimeout(isScrolling);
        isScrolling = setTimeout(checkInfiniteLoop, 60); // Check shortly after scroll stops
      });

      // Resize Listener
      window.addEventListener('resize', () => {
        scrollToSlide(currentIndex, 'instant');
      });

      // Buttons
      const prevBtn = container.querySelector('[data-direction="prev"]');
      const nextBtn = container.querySelector('[data-direction="next"]');

      function move(direction) {
        if (direction === 'next') {
          currentIndex++;
        } else {
          currentIndex--;
        }
        // Clamp to array bounds (though loop should prevent hitting edges)
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= allSlides.length) currentIndex = allSlides.length - 1;

        scrollToSlide(currentIndex, 'smooth');
      }

      if (prevBtn) prevBtn.onclick = (e) => { e.preventDefault(); move('prev'); };
      if (nextBtn) nextBtn.onclick = (e) => { e.preventDefault(); move('next'); };
    }

    document.addEventListener("DOMContentLoaded", initReviewCarousel);
    document.addEventListener("shopify:section:load", (e) => {
      if (e.detail.sectionId === "{{ section.id }}") initReviewCarousel();
    });
  })();
</script>

{% schema %}
{
"name": "Custom Review Carousel",
"tag": "section",
"class": "section",
"settings": [
{
"type": "text",
"id": "title",
"label": "Section Heading",
"default": "WHAT’RE THEY SAYING?"
},
{
"type": "color",
"id": "bg_color",
"label": "Background Color",
"default": "#FFFFFF"
}
],
"blocks": [
{
"type": "review",
"name": "Review Card",
"settings": [
{
"type": "image_picker",
"id": "image",
"label": "Review Image"
},
{
"type": "range",
"id": "rating",
"min": 1,
"max": 5,
"step": 0.5,
"label": "Rating",
"default": 5
},
{
"type": "text",
"id": "heading",
"label": "Review Headline",
"default": "VERSATILE PAIR THAT GOES WITH ANY OUTFIT!"
},
{
"type": "textarea",
"id": "text",
"label": "Review Content",
"default": "The color looks really clean and premium and the design is simple and stylish. Totally worth it!"
},
{
"type": "text",
"id": "author",
"label": "Reviewer Name",
"default": "Ankit P."
},
{
"type": "product",
"id": "product",
"label": "Product (Optional)",
"info": "Links the review to a specific product."
}
]
}
],
"presets": [
{
"name": "Custom Review Carousel",
"blocks": [
{ "type": "review" },
{ "type": "review" },
{ "type": "review" },
{ "type": "review" },
{ "type": "review" }
]
}
]
}
{% endschema %}