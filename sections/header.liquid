<header class="sticky top-0 w-full h-0 overflow-visible z-10">
  <div class="py-4 px-4">
    <div
      class="mx-auto main-header-2 backdrop-blur-[2px] w-full px-2 md:px-4 py-2 rounded-md text-white transition-[background-color] hover:bg-[rgba(25,25,25,0.8)]!">
      <div class="flex justify-between items-center">
        <div class="flex items-center md:hidden">
          <span class="border border-transparent hover:border-white p-2 block md:hidden" sidebar-toggle>
            {% render 'icon'
            , icon: 'menu'
            , size: 20 %}
          </span>

          <button type="button" class="border border-transparent hover:border-white p-2 block md:hidden"
            searchbar-toggle>
            {% render 'icon'
            , icon: 'search'
            , size: 20 %}
          </button>
        </div>

        {% comment %} Logo {% endcomment %}
        <div>
          <a href="/" class="text-xl md:text-2xl font-medium uppercase font-brand">{{ shop.name }}</a>
        </div>

        {% comment %} Right side icons {% endcomment %}
        <div class="shrink-0 flex items-center gap-0 md:gap-2">

          <!-- Navigation -->
          <nav class="hidden md:flex items-center gap-4 lg:gap-6 py-2 justify-center-safe uppercase">
            {% for link in linklists.main-menu.links %}
            <div class="relative nth-last-[2]:text-red-500 last:text-shadow-lg last:text-red-500 group">
              <a href="{{ link.url }}" class="hover:opacity-80 transition-colors">
                {{ link.title }}
              </a>
              {% if link.links != blank %}
              <div class="absolute top-full left-1/2 -translate-x-1/2 py-2 uppercase">
                <div class="bg-zinc-200/70 border border-zinc-200 w-48 group-hover:block hidden">
                  {% for link in link.links %}
                  <a href="{{ link.url }}" class="transition-colors p-2 block hover:opacity-80 text-sm">
                    {{ link.title }}
                  </a>
                  {% endfor %}
                </div>
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </nav>

          <button type="button" class="border border-transparent hover:border-white p-2 md:block hidden"
            searchbar-toggle>
            {% render 'icon'
            , icon: 'search', size: 20 %}
          </button>
          <button type="button" data-wishlist-open class="relative border border-transparent hover:border-white p-2">
            {% render 'icon'
            , icon: 'wishlist', size: 20 %}
            <div
              class="wishlist-badge absolute -top-1 -right-1 hidden h-4 w-4 items-center justify-center rounded-full bg-black text-xs font-medium text-white">
              <span id="wishlist-count-badge" class="wishlist-count">0</span>
            </div>
          </button>
          <button type="button" data-cart-open class="relative border border-transparent hover:border-white p-2">
            {% render 'icon'
            , icon: 'cart', size: 20 %}
            {% if cart.item_count > 0 %}
            <span
              class="absolute -top-2 -right-2 bg-black text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
              {{ cart.item_count }}
            </span>
            {% endif %}
          </button>
          <div class="border border-transparent hover:border-white p-2 hidden md:block">
            {% if customer %}
            <a href="{{ routes.account_url }}">
              {% render 'icon'
              , icon: 'account', size: 20 %}
            </a>
            {% else %}
            <a href="{{ routes.account_login_url }}">
              {% render 'icon'
              , icon: 'account', size: 20 %}
            </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Collapsible Search Bar -->
  <div
    class="px-4 md:px-6 grid transition-[grid-template-rows] duration-300 grid-rows-[0fr] data-[state=expanded]:grid-rows-[1fr] group"
    data-searchbar data-state="collapsed">
    <div class="group-data-[state=collapsed]:overflow-hidden">
      <div class="relative">
        <form action="{{ routes.search_url }}" method="get" role="search">
          <div class="flex items-center gap-2 bg-white border border-zinc-300 rounded-md px-3 py-2 shadow-sm">
            <input type="search" name="q" placeholder="Search products..." id="search-input"
              class="flex-1 bg-transparent outline-none text-sm text-black placeholder-zinc-500" aria-label="Search"
              autocomplete="off" />
            <button type="submit" class="text-zinc-700 hover:text-black">{% render 'icon', icon: 'search', size: 16
              %}</button>
          </div>
        </form>
        <!-- Search Suggestions -->
        <div id="search-suggestions"
          class="absolute top-full left-0 right-0 bg-white border border-zinc-300 border-t-0 rounded-b-md shadow-lg z-50 hidden">
          <div id="suggestions-list" class="max-h-64 overflow-y-auto"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile menu -->
  <div
    class="fixed top-0 left-0 bg-white z-10 w-[90vw] h-screen data-[state=collapsed]:-translate-x-full transition-all"
    data-state="collapsed" sidebar>
    <button type="button" sidebar-toggle class="absolute top-2 right-2">
      {% render 'icon'
      , icon: 'x', size: 24 %}
    </button>
    {% render 'sidebar' %}
  </div>
</header>

<header id="main-header" class="shadow transition-all duration-150 ease-in-out z-50 backdrop-blur-md bg-white" hidden>
  <div class="mx-auto">
    <div class="grid grid-cols-[1fr_1fr_1fr] gap-4 py-4 px-4 md:px-8 lg:px-10">

      <div class="flex items-center justify-left-safe">
        <button type="button" class="text-gray-700 hover:text-gray-900" searchbar-toggle>
          {% render 'icon'
          , icon: 'search' %}
        </button>
      </div>

      <!-- Logo -->
      <div class="flex-shrink-0 relative h-10 w-full flex justify-center-safe">
        {% if section.settings.logo != blank %}
        <a href="{{ routes.home_url }}"
          class="absolute grid place-items-center text-2xl font-bold uppercase tracking-wider nav-logo-title left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">{{
          shop.name }}</a>
        <a href="/"
          class="nav-logo opacity-0 absolute grid place-items-center size-16 left-1/2 -translate-x-1/2 top-1/2 -translate-y-1/2">
          <img src="{{ section.settings.logo | image_url: width: 180 }}" alt="{{ shop.name }}"
            class="size-16 object-contain" loading="eager" width="180" height="auto">
        </a>
        {% else %}
        <a href="{{ routes.home_url }}" class="text-2xl font-bold">{{ shop.name }}</a>
        {% endif %}
      </div>


      <!-- Right side icons -->
      <div class="flex items-center gap-2 md:gap-4 lg:gap-6 justify-end-safe">
        <button type="button" data-wishlist-open class="relative text-gray-700 hover:text-gray-900">
          {% render 'icon', icon: 'wishlist' %}
          <div
            class="wishlist-badge absolute -top-1 -right-1 hidden h-4 w-4 items-center justify-center rounded-full bg-black text-xs font-medium text-white">
            <span id="wishlist-count-badge" class="wishlist-count">0</span>
          </div>
        </button>
        <button type="button" data-cart-open class="relative text-gray-700 hover:text-gray-900">
          {% render 'icon'
          , icon: 'cart' %}
          {% if cart.item_count > 0 %}
          <span
            class="absolute -top-2 -right-2 bg-black text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
            {{ cart.item_count }}
          </span>
          {% endif %}
        </button>
        {% if customer %}
        <a href="{{ routes.account_url }}" class="text-gray-700 hover:text-gray-900">
          {% render 'icon'
          , icon: 'account' %}
        </a>
        {% else %}
        <a href="{{ routes.account_login_url }}" class="text-gray-700 hover:text-gray-900">
          {% render 'icon'
          , icon: 'account' %}
        </a>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="hidden md:flex items-center gap-2 md:gap-4 py-2 justify-center-safe">
    {% for link in linklists.main-menu.links %}
    <div class="relative text-gray-700 nth-last-[2]:text-red-500 last:text-red-500 group">
      <a href="{{ link.url }}" class="hover:text-gray-900 transition-colors">
        {{ link.title }}
      </a>
      {% if link.links != blank %}
      <div class="absolute top-full left-1/2 -translate-x-1/2 py-2 uppercase">
        <div class="bg-zinc-200/70 border border-zinc-200 w-48 group-hover:block hidden">
          {% for link in link.links %}
          <a href="{{ link.url }}"
            class="text-zinc-700 hover:text-zinc-900 transition-colors p-2 block hover:bg-zinc-300 text-sm uppercase">
            {{ link.title }}
          </a>
          {% endfor %}
        </div>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </nav>
</header>

{% render 'cart-drawer' %}
{% render 'wishlist-drawer' %}

<script defer async>
  const onScroll = function () {
    const navLogoTitle = document.querySelector('.nav-logo-title');
    const navLogo = document.querySelector('.nav-logo');
    const scrollTop = document.scrollingElement.scrollTop;
    const header = document.querySelector(".main-header-2")

    if (location.pathname !== '/') {
      // header.style.background = "#dddddd50";
      header.style.background = "rgba(25,25,25,0.8)";
      header.style.color = 'white';
      return
    }
    const OPACITY_HEIGHT_RATIO = 50;
    if (scrollTop < OPACITY_HEIGHT_RATIO) {
      navLogoTitle.style.opacity = 100;
      navLogo.style.opacity = 0;
      // header.style.background = "rgba(0, 0, 0, 0.5)";
      header.style.background = "transparent";
      header.style.color = 'white';
    } else if (scrollTop < OPACITY_HEIGHT_RATIO * 2) {
      navLogoTitle.style.opacity = (OPACITY_HEIGHT_RATIO * 2 - scrollTop) / OPACITY_HEIGHT_RATIO;
      navLogo.style.opacity = 0;
      header.style.background = "rgba(100, 100, 100, 0.6)";
      // header.style.background = "rgba(25,25,25,0.8)";
      header.style.color = 'white';
    } else if (scrollTop < OPACITY_HEIGHT_RATIO * 3) {
      navLogoTitle.style.opacity = 0;
      navLogo.style.opacity = (scrollTop - OPACITY_HEIGHT_RATIO * 2) / OPACITY_HEIGHT_RATIO;
      // header.style.background = "rgba(200, 200, 200, 0.6)";
      header.style.background = "rgba(50,50,50,0.8)";
      header.style.color = 'white';
    } else {
      navLogoTitle.style.opacity = 0;
      navLogo.style.opacity = 100;
      // header.style.background = "rgba(241, 241, 241, 0.6)";
      header.style.background = "rgba(25,25,25,0.8)";
      header.style.color = 'white';
    }
  }

  document.addEventListener('DOMContentLoaded', onScroll);
  document.addEventListener('scroll', onScroll);

  // Initialize UI once DOM is ready to avoid async timing issues
  document.addEventListener('DOMContentLoaded', function () {
    const sidebar = document.querySelector('[sidebar]');
    document.querySelectorAll('[sidebar-toggle]').forEach((element) =>
      element.addEventListener('click', function () {
        if (!sidebar) return;
        const current = sidebar.dataset.state;
        sidebar.dataset.state = current === 'expanded' ? 'collapsed' : 'expanded';
      })
    );

    if (location.pathname !== '/search') {
      const searchbar = document.querySelector('[data-searchbar]');
      document.querySelectorAll('[searchbar-toggle]').forEach((el) => {
        el.addEventListener('click', (e) => {
          e.preventDefault();
          if (!searchbar) return;
          const current = searchbar.dataset.state;
          searchbar.dataset.state = current === 'expanded' ? 'collapsed' : 'expanded';
          if (searchbar.dataset.state === 'expanded') {
            const input = searchbar.querySelector('input[name="q"]');
            setTimeout(() => {
              if (input) input.focus();
            }, 50);
          }
        });
      });
    }

    // Close searchbar with Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && searchbar && searchbar.dataset.state === 'expanded') {
        searchbar.dataset.state = 'collapsed';
        hideSuggestions();
      }
    });

    // Search suggestions functionality
    const searchInput = document.getElementById('search-input');
    const suggestionsContainer = document.getElementById('search-suggestions');
    const suggestionsList = document.getElementById('suggestions-list');
    let searchTimeout;

    function showSuggestions() {
      suggestionsContainer.classList.remove('hidden');
    }

    function hideSuggestions() {
      suggestionsContainer.classList.add('hidden');
    }

    function fetchSuggestions(query) {
      if (query.length < 2) {
        hideSuggestions();
        return;
      }

      fetch(`/search/suggest.json?q=${encodeURIComponent(query)}&resources[type]=product&resources[limit]=6`)
        .then(response => response.json())
        .then(data => {
          displaySuggestions(data.resources.results.products || []);
        })
        .catch(() => {
          hideSuggestions();
        });
    }

    function displaySuggestions(products) {
      if (products.length === 0) {
        hideSuggestions();
        return;
      }

      suggestionsList.innerHTML = products.map(product => `
        <a href="${product.url}" class="flex items-center gap-3 p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0">
          <img src="${product.featured_image.url}" alt="${product.title}" class="w-10 h-10 object-cover rounded">
          <div class="flex-1 min-w-0">
            <div class="text-sm font-medium text-gray-900 truncate">${product.title}</div>
            <div class="text-xs text-gray-500">${product.price}</div>
          </div>
        </a>
      `).join('');

      showSuggestions();
    }

    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          fetchSuggestions(e.target.value.trim());
        }, 300);
      });

      searchInput.addEventListener('focus', (e) => {
        if (e.target.value.trim().length >= 2) {
          fetchSuggestions(e.target.value.trim());
        }
      });

      // Hide suggestions when clicking outside
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
          hideSuggestions();
        }
      });
    }
  });

</script>

<script>
  // Wishlist header badge and open handler
  document.addEventListener('DOMContentLoaded', function () {
    function getWishlist() {
      try {
        const items = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
        return Array.isArray(items) ? items : [];
      } catch (e) {
        console.error('Error reading wishlist:', e);
        return [];
      }
    }

    function updateWishlistBadge() {
      try {
        console.log('Updating wishlist badge...');
        const wishlist = getWishlist();
        const badge = document.querySelector('.wishlist-badge');
        const count = wishlist.length;

        if (badge) {
          const countEl = badge.querySelector('.wishlist-count');
          if (countEl) countEl.textContent = count;

          badge.classList.toggle('hidden', count === 0);
          badge.classList.toggle('inline-flex', count > 0);
        }
      } catch (e) {
        console.error('Error updating wishlist badge:', e);
      }
    }

    // Handle wishlist open button
    function initWishlistButton() {
      const wishlistButton = document.querySelector('[data-wishlist-open]');
      if (!wishlistButton) {
        console.log('Wishlist button not found in the DOM');
        return;
      }

      console.log('Initializing wishlist button...');

      wishlistButton.addEventListener('click', function (e) {
        e.preventDefault();
        e.stopPropagation();

        console.log('Wishlist button clicked');
        console.log('Window.WishlistDrawer:', window.WishlistDrawer);

        if (window.WishlistDrawer && typeof window.WishlistDrawer.open === 'function') {
          console.log('Opening wishlist drawer directly');
          window.WishlistDrawer.open();
        } else {
          console.log('WishlistDrawer not available yet, waiting for ready event...');

          // If drawer not ready, wait for it
          const onWishlistReady = () => {
            console.log('wishlist:ready event received');
            console.log('Window.WishlistDrawer after event:', window.WishlistDrawer);

            if (window.WishlistDrawer && typeof window.WishlistDrawer.open === 'function') {
              console.log('Opening wishlist drawer after ready event');
              window.WishlistDrawer.open();
              document.removeEventListener('wishlist:ready', onWishlistReady);
            } else {
              console.error('WishlistDrawer still not available after ready event');
            }
          };

          document.addEventListener('wishlist:ready', onWishlistReady);

          // Also try to open after a short delay in case the event was missed
          setTimeout(() => {
            if (window.WishlistDrawer && typeof window.WishlistDrawer.open === 'function') {
              console.log('Opening wishlist drawer after timeout');
              window.WishlistDrawer.open();
              document.removeEventListener('wishlist:ready', onWishlistReady);
            }
          }, 500);
        }
      });
    }

    // Initial setup
    updateWishlistBadge();
    initWishlistButton();

    // Listen for wishlist updates
    window.addEventListener('wishlist:updated', updateWishlistBadge);

    // Also update when the page becomes visible again (in case changes were made in another tab)
    document.addEventListener('visibilitychange', function () {
      if (!document.hidden) {
        updateWishlistBadge();
      }
    });

    console.log('Wishlist header initialized');
  });
</script>

{% schema %}
{
"name": "Header",
"class": "sticky top-0 z-10",
"settings": [
{
"type": "image_picker",
"id": "logo",
"label": "Logo",
"info": "Recommended size: 180x40px"
}
],
"presets": [
{
"name": "Header",
"category": "Header"
}
]
}
{% endschema %}