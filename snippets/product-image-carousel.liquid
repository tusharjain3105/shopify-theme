{% comment %}
Product Image Carousel with Swiper - Fixed Version
Usage: {% render 'product-image-carousel', product: product, mobile: true/false %}
{% endcomment %}

{% assign is_mobile = mobile | default: false %}
{% assign carousel_id = 'product-carousel-' | append: product.id %}

<div class="product-image-carousel relative" data-product-id="{{ product.id }}"
  data-product-handle="{{ product.handle }}" data-product-title="{{ product.title | escape }}"
  data-product-price="{{ product.price }}" data-product-url="{{ product.url }}"
  data-product-image="{{ product.featured_image | img_url: '400x400' }}"
  >
  {% if product.images.size > 0 %}
  <div class="swiper {{ carousel_id }} relative">
    <!-- Wishlist button at carousel level -->
    <button type="button"
      class="wishlist-toggle absolute top-2 right-2 z-20 rounded-full bg-white/90 hover:bg-white shadow p-2 text-gray-700 data-active:*:fill-black data-active:*:text-black transition-colors"
      aria-label="Add to wishlist" data-wishlist-toggle data-product-id="{{ product.id }}"
      data-product-title="{{ product.title | escape }}" data-product-price="{{ product.price }}"
      data-product-url="{{ product.url }}" data-product-image="{{ product.featured_image | img_url: '400x400' }}"
      data-variant-id="{{ product.selected_or_first_available_variant.id }}"
      style="z-index: 20;">
      {% render 'icon', icon: 'wishlist' %}
    </button>

    <div class="swiper-wrapper">
      {% for image in product.images %}
      <div class="swiper-slide">
        <div class="aspect-image overflow-hidden bg-gray-100">
          <img src="{{ image | img_url: '800x800' }}"
            srcset="{{ image | img_url: '400x400' }} 400w, {{ image | img_url: '800x800' }} 800w"
            sizes="(max-width: 768px) 400px, 800px" alt="{{ image.alt | default: product.title | escape }}"
            class="w-full object-cover aspect-image" loading="{% if forloop.first %}eager{% else %}lazy{% endif %}"
            onerror="this.src='image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjgwIiBoZWlnaHQ9IjgwIiBmaWxsPSIjRjNGNEY2Ii8+CjxwYXRoIGQ9Ik0yNCAyNEg1NlY1Nkg0NFY0NEgyNFYyNFoiIGZpbGw9IiM5Q0E0QUYiLz4KPHBhdGggZD0iTTQ0IDQ0TDUyIDM2TDU2IDQwVjU2SDI0VjQ0SDQ0WiIgZmlsbD0iIzlDQTRBRiIvPgo8L3N2Zz4K'" />
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Thumbnail Navigation (Desktop Only) -->
  {% comment %} {% unless is_mobile %} {% endcomment %}
  {% if product.images.size > 1 %}
  <div class="thumbnail-nav mt-4 grid grid-cols-5 gap-2 px-4">
    {% for image in product.images limit: 5 %}
    <button
      class="thumbnail-btn aspect-image overflow-hidden border-2 {% if forloop.first %}border-gray-800{% else %}border-transparent{% endif %} hover:border-gray-400 transition-colors"
      data-slide="{{ forloop.index0 }}">
      <img src="{{ image | img_url: '120x120' }}" alt="{{ image.alt | default: product.title | escape }}"
        class="w-full aspect-image object-cover" loading="eager" />
    </button>
    {% endfor %}
  </div>
  {% endif %}
  {% comment %} {% endunless %} {% endcomment %}
  {% else %}
  <!-- Fallback when no images -->
  <div class="no-image-placeholder aspect-square bg-gray-100 flex items-center justify-center">
    <svg class="w-16 h-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
        d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
    </svg>
  </div>
  {% endif %}
</div>

<!-- Swiper CSS & JS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    console.log('Initializing carousel for product {{ product.id }}');
    console.log('Images count: {{ product.images.size }}');

    {% if product.images.size > 0 %}
    // Add hover effect for navigation arrows
    const carouselContainer = document.querySelector('.{{ carousel_id }}').closest('.product-image-carousel');
    if (carouselContainer) {
      carouselContainer.classList.add('group');
    }

    {% assign should_loop = false %}
    {% if product.images.size > 1 %}
    {% assign should_loop = true %}
    {% endif %}

    const carousel{{ product.id }} = new Swiper('.{{ carousel_id }}', {
      slidesPerView: 1,
      spaceBetween: 0,
      loop: {{ should_loop }},
      grabCursor: true,

      {% if product.images.size > 1 %}
      navigation: {
        nextEl: '.{{ carousel_id }} .swiper-button-next',
        prevEl: '.{{ carousel_id }} .swiper-button-prev',
      },
      pagination: {
        el: '.{{ carousel_id }} .swiper-pagination',
        clickable: true,
        dynamicBullets: true,
      },
      {% endif %}

      a11y: {
        prevSlideMessage: 'Previous image',
        nextSlideMessage: 'Next image',
      },
      lazy: { loadPrevNext: true },
      on: {
        init: function () {
          console.log('Carousel initialized successfully');
        },
        slideChange: function () {
          console.log('Slide changed to: ' + this.realIndex);
          const activeIndex = this.realIndex;
          document.querySelectorAll('.thumbnail-btn').forEach((btn, index) => {
            if (index === activeIndex) {
              btn.classList.remove('border-transparent');
              btn.classList.add('border-gray-800');
            } else {
              btn.classList.remove('border-gray-800');
              btn.classList.add('border-transparent');
            }
          });
        }
      }
    });

    {% unless is_mobile %}
    document.querySelectorAll('.thumbnail-btn').forEach((btn, index) => {
      btn.addEventListener('click', function () {
        console.log('Thumbnail clicked: ' + index);
        const slideIndex = parseInt(this.dataset.slide);
        const swipers = [carousel{{ product.id }}].flat();
        swipers.forEach(swiper => swiper.slideTo(slideIndex));
      });
    });
    {% endunless %}

    document.addEventListener('keydown', function (e) {
      if (e.key === 'ArrowLeft') {
        carousel{{ product.id }}.slidePrev();
      } else if (e.key === 'ArrowRight') {
        carousel{{ product.id }}.slideNext();
      }
    });

    {% else %}
    console.log('No images found for product {{ product.id }}');
    {% endif %}
  });
</script>

<style>
  .{{ carousel_id }} .swiper-button-next,
  .{{ carousel_id }} .swiper-button-prev {
    color: #111827;
    background: rgba(255, 255, 255, 0.8);
    width: 32px;
    height: 32px;
    border-radius: 50%;
    backdrop-filter: blur(4px);
    transition: all 0.2s ease;
  }

  .{{ carousel_id }} .swiper-button-next:after,
  .{{ carousel_id }} .swiper-button-prev:after {
    font-size: 14px;
    font-weight: bold;
  }

  .{{ carousel_id }} .swiper-button-next:hover,
  .{{ carousel_id }} .swiper-button-prev:hover {
    background: white;
    transform: scale(1.1);
  }

  .{{ carousel_id }} .swiper-button-prev {
    left: 10px;
  }

  .{{ carousel_id }} .swiper-button-next {
    right: 10px;
  }

  .{{ carousel_id }} .swiper-pagination-bullet {
    width: 8px;
    height: 8px;
    background: #d1d5db;
    opacity: 1;
    transition: all 0.3s ease;
  }

  .{{ carousel_id }} .swiper-pagination-bullet-active {
    background: #374151;
    transform: scale(1.2);
  }

  .product-image-carousel .swiper-slide img {
    transition: transform 0.3s ease;
  }

  .product-image-carousel:hover .swiper-slide img {
    transform: scale(1.05);
  }
</style>
<!-- Zoom Overlay Implementation -->
<div id="zoom-overlay-{{ product.id }}"
  class="fixed inset-0 z-50 hidden bg-black flex-col items-center justify-center opacity-0 transition-opacity duration-300"
  aria-hidden="true" style="touch-action: none;">

  <!-- Viewport -->
  <div class="zoom-viewport w-full h-full overflow-hidden flex items-center justify-center relative">
    <img id="zoom-img-{{ product.id }}" src="" alt="Zoom view"
      class="max-w-full max-h-full object-contain origin-center select-none" draggable="false"
      style="transform: translate3d(0,0,0) scale(1); will-change: transform;">
  </div>

  <!-- Toolbar -->
  <div
    class="absolute top-0 left-0 w-full p-4 flex justify-between items-center z-[60] bg-gradient-to-b from-black/50 to-transparent">
    <span id="zoom-counter-{{ product.id }}" class="text-white font-medium text-sm tracking-wide"></span>
    <button id="zoom-close-{{ product.id }}" class="text-white p-2 hover:bg-white/20 rounded-full transition-colors"
      aria-label="Close zoom">
      <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>

  <!-- Navigation Buttons -->
  <button id="zoom-prev-{{ product.id }}"
    class="absolute left-4 top-1/2 -translate-y-1/2 z-[60] text-white p-3 hover:bg-white/20 rounded-full transition-colors disabled:opacity-30"
    aria-label="Previous image">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
  </button>
  <button id="zoom-next-{{ product.id }}"
    class="absolute right-4 top-1/2 -translate-y-1/2 z-[60] text-white p-3 hover:bg-white/20 rounded-full transition-colors disabled:opacity-30"
    aria-label="Next image">
    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
  </button>
</div>

<script>
  (function () {
    // Data setup
    const productImages = [
      {% for image in product.images %}
        "{{ image | img_url: 'master' }}"{% unless forloop.last %}, {% endunless %}
  {% endfor %}
    ];
  let currentIndex = 0;

  // State
  const state = {
    scale: 1,
    panning: false,
    pointX: 0,
    pointY: 0,
    startX: 0,
    startY: 0,
    lastX: 0,
    lastY: 0,
    isZooming: false,
    startDist: 0,
    startScale: 1
  };

  // Elements
  const overlay = document.getElementById('zoom-overlay-{{ product.id }}');
  const imgElement = document.getElementById('zoom-img-{{ product.id }}');
  const closeBtn = document.getElementById('zoom-close-{{ product.id }}');
  const nextBtn = document.getElementById('zoom-next-{{ product.id }}');
  const prevBtn = document.getElementById('zoom-prev-{{ product.id }}');
  const counter = document.getElementById('zoom-counter-{{ product.id }}');
  // Scope slides to this specific product carousel
  const slides = document.querySelectorAll('.product-image-carousel[data-product-id="{{ product.id }}"] .swiper-slide img');

  // === Core Transform Logic ===
  function updateTransform() {
    imgElement.style.transform = `translate3d(${state.pointX}px, ${state.pointY}px, 0) scale(${state.scale})`;
  }

  function resetZoom() {
    state.scale = 1;
    state.pointX = 0;
    state.pointY = 0;
    updateTransform();
  }

  function loadImage(index) {
    if (index < 0) index = productImages.length - 1;
    if (index >= productImages.length) index = 0;
    currentIndex = index;

    imgElement.src = productImages[currentIndex];
    counter.textContent = `${currentIndex + 1} / ${productImages.length}`;
    resetZoom();
  }

  // === Event Handlers ===

  function openOverlay(index) {
    loadImage(index);
    overlay.classList.remove('hidden');
    overlay.classList.add('flex');
    requestAnimationFrame(() => {
      overlay.classList.remove('opacity-0');
    });
    document.body.style.overflow = 'hidden';
  }

  function closeOverlay() {
    overlay.classList.add('opacity-0');
    setTimeout(() => {
      overlay.classList.remove('flex');
      overlay.classList.add('hidden');
      resetZoom();
      imgElement.src = '';
    }, 300);
    document.body.style.overflow = '';
  }

  // Attach click to this carousel's images only
  slides.forEach((img, idx) => {
    img.style.cursor = 'zoom-in';
    img.addEventListener('click', (e) => {
      e.preventDefault();
      openOverlay(idx);
    });
  });

  if (closeBtn) closeBtn.addEventListener('click', closeOverlay);
  if (nextBtn) nextBtn.addEventListener('click', (e) => { e.stopPropagation(); loadImage(currentIndex + 1); });
  if (prevBtn) prevBtn.addEventListener('click', (e) => { e.stopPropagation(); loadImage(currentIndex - 1); });

  // === Gestures ===

  let lastTap = 0;
  imgElement.addEventListener('click', (e) => {
    const currentTime = new Date().getTime();
    const tapLength = currentTime - lastTap;
    if (tapLength < 300 && tapLength > 0) {
      e.preventDefault();
      if (state.scale > 1) {
        resetZoom();
      } else {
        state.scale = 2.5;
        state.pointX = 0;
        state.pointY = 0;
        updateTransform();
      }
    }
    lastTap = currentTime;
  });

  overlay.addEventListener('wheel', (e) => {
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      const delta = -e.deltaY * 0.01;
      const newScale = Math.min(Math.max(1, state.scale + delta), 4);
      state.scale = newScale;
      if (state.scale === 1) { state.pointX = 0; state.pointY = 0; }
      updateTransform();
    }
  }, { passive: false });

  function getDistance(touches) {
    return Math.hypot(
      touches[0].pageX - touches[1].pageX,
      touches[0].pageY - touches[1].pageY
    );
  }

  overlay.addEventListener('touchstart', (e) => {
    // Allow interaction with buttons
    if (e.target.closest('button')) return;

    if (e.touches.length === 2) {
      state.isZooming = true;
      state.startDist = getDistance(e.touches);
      state.startScale = state.scale;
    } else if (e.touches.length === 1) {
      state.panning = true;
      state.startX = e.touches[0].pageX - state.pointX;
      state.startY = e.touches[0].pageY - state.pointY;
      state.touchStartX = e.touches[0].pageX;
      state.touchStartY = e.touches[0].pageY;
    }
  }, { passive: false });

  overlay.addEventListener('touchmove', (e) => {
    // If pressing button, don't move
    if (e.target.closest('button')) return;
    e.preventDefault();

    if (state.isZooming && e.touches.length === 2) {
      const dist = getDistance(e.touches);
      const scaleChange = dist / state.startDist;
      const newScale = Math.min(Math.max(1, state.startScale * scaleChange), 4);

      state.scale = newScale;
      updateTransform();
    } else if (state.panning && e.touches.length === 1 && state.scale > 1) {
      e.preventDefault();
      state.pointX = e.touches[0].pageX - state.startX;
      state.pointY = e.touches[0].pageY - state.startY;
      updateTransform();
    }
  }, { passive: false });

  overlay.addEventListener('touchend', (e) => {
    if (e.target.closest('button')) return;

    if (e.touches.length < 2) {
      state.isZooming = false;
    }
    if (e.touches.length === 0) {
      // Swipe Detection when not zoomed
      if (state.scale === 1 && state.panning && e.changedTouches.length > 0) {
        const diffX = e.changedTouches[0].pageX - state.touchStartX;
        const diffY = e.changedTouches[0].pageY - state.touchStartY;

        // Threshold for swipe
        if (Math.abs(diffX) > 50 && Math.abs(diffY) < 100) {
          if (diffX > 0) {
            loadImage(currentIndex - 1);
          } else {
            loadImage(currentIndex + 1);
          }
        }
      }

      state.panning = false;
      if (state.scale <= 1) {
        resetZoom();
      }
    }
  });

  // Mouse Drag (Desktop Pan)
  let isMouseDown = false;
  imgElement.addEventListener('mousedown', (e) => {
    if (state.scale > 1) {
      isMouseDown = true;
      state.startX = e.clientX - state.pointX;
      state.startY = e.clientY - state.pointY;
      imgElement.style.cursor = 'grabbing';
      e.preventDefault();
    }
  });

  window.addEventListener('mousemove', (e) => {
    if (!isMouseDown) return;
    e.preventDefault();
    state.pointX = e.clientX - state.startX;
    state.pointY = e.clientY - state.startY;
    updateTransform();
  });

  window.addEventListener('mouseup', () => {
    isMouseDown = false;
    imgElement.style.cursor = state.scale > 1 ? 'grab' : 'default';
  });

  }) ();
</script>