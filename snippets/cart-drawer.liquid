{% comment %}
Reusable Cart Drawer
Includes overlay + right-side panel, basic cart summary, and controls.
Usage: place `{% render 'cart-drawer' %}` once (e.g., in `layout/theme.liquid` or header) and trigger with
`[data-cart-open]`.
{% endcomment %}

<div id="cart-drawer" class="fixed inset-0 z-[60] pointer-events-none font-outfit">
  <!-- Overlay -->
  <div data-cart-overlay class="hidden absolute inset-0 bg-black/40 opacity-0 transition-opacity duration-200"></div>

  <!-- Panel -->
  <aside data-cart-panel
    class="absolute right-0 top-0 h-full w-full md:w-[400px] bg-white shadow-xl translate-x-full transition-transform duration-300 flex flex-col">
    {% render 'toast' %}
    <!-- Header -->
    <div class="flex items-center justify-between p-4 bg-white border-b sticky top-0 z-10">
      <h3 class="text-lg font-semibold font-outfit" data-cart-title>Your Cart (0 items)</h3>
      <button type="button" data-cart-close class="p-2 text-gray-500 hover:text-gray-800" aria-label="Close cart">
        {% render 'icon', icon: 'x', size: 24 %}
      </button>
    </div>

    <!-- Banner -->
    {% comment %} Banner removed as per user request {% endcomment %}

    <!-- Scrollable Content -->
    <div class="flex-1 overflow-y-auto no-scrollbar">

      <!-- Rewards Progress - Gauge Style with Needle -->
      <div class="py-4 bg-white mb-2 pt-6">
        <div class="relative w-[80%] mx-auto mb-8">
          <!-- SVG Gauge -->
          <svg viewBox="0 0 200 100" class="w-full h-full transform overflow-visible">
            <!-- Defs for gradients/shadows -->
            <defs>
              <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.2" />
              </filter>
            </defs>

            <!-- Background Arc -->
            <path d="M 10 100 A 90 90 0 0 1 190 100" fill="none" stroke="#e5e7eb" stroke-width="8"
              stroke-linecap="round" />

            <!-- Active Progress Arc (Colored) -->
            <!-- Total length is ~282.7 -->
            <path id="gauge-progress" d="M 10 100 A 90 90 0 0 1 190 100" fill="none"
              class="text-black transition-[stroke-dashoffset] duration-700 ease-out" stroke="currentColor"
              stroke-width="4" stroke-linecap="round" stroke-dasharray="282.7" stroke-dashoffset="282.7" />
          </svg>

          <!-- Central Text Display -->
          <div class="absolute bottom-5 left-1/2 transform -translate-x-1/2 text-center w-full px-12">
            <p class="text-xl font-black text-black uppercase tracking-widest leading-none font-special-gothic"
              style="text-shadow: 1px 1px 0 #9ca3af;" data-gauge-text>Shipping on us — almost
            </p>
          </div>

          <!-- Checkpoint Icons (Absolute overlay using computed percentages) -->
          <!-- 699 (33%) -> 60deg -> ~27.5% left, ~22% top -->
          <div
            class="absolute w-8 h-8 -ml-4 -mt-4 flex items-center justify-center bg-white rounded-full shadow-sm border border-gray-100 transition-colors duration-300 z-10"
            style="left: 27.5%; top: 22%;" data-cpoint="699">
            <div class="text-gray-400 transition-colors duration-300">{% render 'icon', icon: 'shipping', size: 16 %}
            </div>
          </div>

          <!-- 899 (66%) -> 120deg -> ~72.5% left, ~22% top -->
          <div
            class="absolute w-8 h-8 -ml-4 -mt-4 flex items-center justify-center bg-white rounded-full shadow-sm border border-gray-100 transition-colors duration-300 z-10"
            style="left: 72.5%; top: 22%;" data-cpoint="899">
            <div class="text-gray-400 transition-colors duration-300">{% render 'icon', icon: 'discount', size: 16 %}
            </div>
          </div>

          <!-- 1099 (100%) -> 180deg -> ~95% left, ~100% top (bottom-right) -->
          <div
            class="absolute w-8 h-8 -ml-4 -mt-4 flex items-center justify-center bg-white rounded-full shadow-sm border border-gray-100 transition-colors duration-300 z-10"
            style="left: 95%; top: 100%;" data-cpoint="1099">
            <div class="text-gray-400 transition-colors duration-300">{% render 'icon', icon: 'discount', size: 16 %}
            </div>
          </div>

          <!-- Text Labels -->
          <!-- 699 Label -->
          <div class="absolute -translate-x-1/2 -translate-y-full pb-2 text-center pointer-events-none"
            style="left: 27.5%; top: 18%;">
            <span class="text-[10px] font-bold uppercase tracking-wider block whitespace-nowrap">Free <br /> Ship</span>
          </div>

          <!-- 899 Label -->
          <div class="absolute -translate-x-1/2 -translate-y-full pb-2 text-center pointer-events-none"
            style="left: 72.5%; top: 18%;">
            <span class="text-[10px] font-bold uppercase tracking-wider block whitespace-nowrap">Flat<br /> ₹70 Off</span>
          </div>

          <!-- 1099 Label -->
          <div class="absolute -translate-x-1/2 -translate-y-full pb-2 text-center pointer-events-none"
            style="left: 104%; top: 90%;">
            <span class="text-[10px] font-bold uppercase tracking-wider block whitespace-nowrap">Flat<br /> ₹120 Off</span>
          </div>
        </div>
        <p class="text-center text-sm font-medium mt-10 text-white bg-black py-1" data-reward-message>Add
          items to unlock rewards</p>
      </div>

      <!-- Cart Items -->
      <div data-cart-content class="py-4 bg-white mb-2 min-h-[100px]">
        <div class="text-sm text-gray-500 text-center py-8">Loading your cart...</div>
      </div>

      <!-- Coupon Code -->
      <div class="p-4 bg-white mb-2">
        <div class="border rounded-md p-1 flex items-center bg-white shadow-sm">
          <span class="pl-2 text-green-500">{% render 'icon', icon: 'discount', size: 16 %}</span>
          <input type="text" placeholder="Enter Coupon Code"
            class="flex-1 p-2 text-sm outline-none bg-transparent placeholder-gray-400">
        </div>
        {% comment %} <button onclick="document.getElementById('offers-list').classList.toggle('hidden')"
          class="w-full text-left text-blue-600 text-sm font-medium mt-2 flex items-center hover:underline">
          View All Offers {% render 'icon', icon: 'chevron-right', size: 12 %}
        </button>
        <div id="offers-list" class="hidden mt-2 space-y-2 border-t pt-2">
          <div
            class="bg-blue-50 p-2 rounded text-xs border border-blue-100 border-dashed flex justify-between items-center cursor-pointer hover:bg-blue-100">
            <span class="font-bold text-blue-800">WELCOME10</span>
            <span class="text-blue-600">10% Off First Order</span>
          </div>
          <div
            class="bg-green-50 p-2 rounded text-xs border border-green-100 border-dashed flex justify-between items-center cursor-pointer hover:bg-green-100">
            <span class="font-bold text-green-800">PREPAID5</span>
            <span class="text-green-600">Extra 5% on Prepaid</span>
          </div>
        </div> {% endcomment %}
      </div>

      <!-- Wishlist Section (Hidden by default) -->
      <div id="cart-wishlist-section" class="hidden p-4 bg-white border-t">
        <h4 class="text-lg font-bold uppercase mb-4">From your wishlist</h4>
        <div class="overflow-x-auto no-scrollbar -mx-4 px-4">
          <div id="cart-wishlist-items" class="flex gap-3 pb-2" style="width: max-content;">
            <!-- Items injected via JS -->
          </div>
        </div>
      </div>

      <!-- Cross Sells (Carousel) -->
      <div class="p-4 bg-white border-t">
        <h4 class="text-lg font-bold uppercase mb-4">You may also like</h4>
        <div class="overflow-x-auto no-scrollbar -mx-4 px-4">
          <div class="flex gap-3 pb-2" style="width: max-content;">
            {% assign related_products = collections['all'].products | where: "available" %}
            {% for product in related_products limit: 4 %}
            <div class="w-40 flex-shrink-0 bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden">
              {% render 'product-card-enhanced', product: product, show_add_to_cart: true %}
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Spacer for footer -->
      <div class="h-48"></div>
    </div>

    <!-- Footer -->
    <div class="absolute bottom-0 left-0 right-0 bg-white border-t p-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-20">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          {% render 'icon', icon: 'note', size: 20 %}
          <span class="text-lg font-semibold">Estimated Total</span>
          {% render 'icon', icon: 'chevron-down', size: 14 %}
        </div>
        <span data-cart-subtotal class="text-xl font-bold font-outfit">₹0.00</span>
      </div>

      <div class="w-full">
        {% render 'gokwik-checkout' %}
      </div>
    </div>
  </aside>
</div>

<script>
  (() => {
    // Store cart state for optimistic updates
    let currentCartState = null;

    const drawer = document.getElementById('cart-drawer');
    if (!drawer) return;

    const overlay = drawer.querySelector('[data-cart-overlay]');
    const panel = drawer.querySelector('[data-cart-panel]');
    const content = drawer.querySelector('[data-cart-content]');
    const subtotalEl = drawer.querySelector('[data-cart-subtotal]');
    const titleEl = drawer.querySelector('[data-cart-title]');
    const progressPath = document.getElementById('gauge-progress');
    const gaugeTextEl = drawer.querySelector('[data-gauge-text]');
    const rewardMsgEl = drawer.querySelector('[data-reward-message]');

    // Checkpoints
    const cpointEls = {
      699: drawer.querySelector('[data-cpoint="699"]'),
      899: drawer.querySelector('[data-cpoint="899"]'),
      1099: drawer.querySelector('[data-cpoint="1099"]')
    };

    const SHIPPING_THRESHOLD = 69900;
    const DISCOUNT_1_THRESHOLD = 89900;
    const DISCOUNT_2_THRESHOLD = 109900;
    const ARC_LENGTH = 282.7; // PI * 90 (radius)

    const open = () => {
      drawer.style.pointerEvents = 'auto';
      overlay.classList.remove('hidden');
      requestAnimationFrame(() => {
        overlay.classList.remove('opacity-0');
        panel.classList.remove('translate-x-full');
        document.documentElement.classList.add('overflow-hidden');
      });
      fetchCart();
      renderWishlist(); // Render wishlist on open
    };

    const close = () => {
      overlay.classList.add('opacity-0');
      panel.classList.add('translate-x-full');
      document.documentElement.classList.remove('overflow-hidden');
      setTimeout(() => {
        overlay.classList.add('hidden');
        drawer.style.pointerEvents = 'none';
      }, 300);
    };

    const formatMoney = (cents) => {
      try {
        return new Intl.NumberFormat('{{ shop.locale | default: 'en - US' }}', { style: 'currency', currency: 'INR' }).format((cents || 0) / 100);
      } catch (e) {
        return '₹' + (cents / 100).toFixed(2);
      }
    };

    const updateRewards = (totalPrice) => {
      // 3-Segment Progress Calculation
      let progress = 0;
      let statusText = '';

      if (totalPrice < SHIPPING_THRESHOLD) {
        // Segment 1: 0 -> SHIPPING_THRESHOLD (0% -> 33%)
        const segmentProgress = totalPrice / SHIPPING_THRESHOLD;
        progress = segmentProgress * 0.33;
        statusText = 'Shipping on us — almost';
      } else if (totalPrice < DISCOUNT_1_THRESHOLD) {
        // Segment 2: SHIPPING_THRESHOLD -> DISCOUNT_1_THRESHOLD (33% -> 66%)
        // Normalized progress within this segment
        const segmentRange = DISCOUNT_1_THRESHOLD - SHIPPING_THRESHOLD;
        const valueInSegment = totalPrice - SHIPPING_THRESHOLD;
        const segmentProgress = valueInSegment / segmentRange;
        progress = 0.33 + (segmentProgress * 0.33);
        statusText = 'Almost there — ₹70 off';
      } else if (totalPrice < DISCOUNT_2_THRESHOLD) {
        // Segment 3: DISCOUNT_1_THRESHOLD -> DISCOUNT_2_THRESHOLD (66% -> 100%)
        const segmentRange = DISCOUNT_2_THRESHOLD - DISCOUNT_1_THRESHOLD;
        const valueInSegment = totalPrice - DISCOUNT_1_THRESHOLD;
        const segmentProgress = valueInSegment / segmentRange;
        progress = 0.66 + (segmentProgress * 0.34);
        statusText = 'Go all the way — ₹120 off';
      } else {
        // Maxed out
        progress = 1;
        statusText = 'You have unlocked all rewards!';
      }

      // Update Gauge Arc
      const dashOffset = ARC_LENGTH * (1 - progress);
      if (progressPath) progressPath.style.strokeDashoffset = dashOffset;

      // Update Central Text
      if (gaugeTextEl) gaugeTextEl.textContent = statusText;

      // Update Message Bar
      if (rewardMsgEl) {
        if (totalPrice < SHIPPING_THRESHOLD) {
          const diff = SHIPPING_THRESHOLD - totalPrice;
          rewardMsgEl.innerHTML = `Just <strong>${formatMoney(diff)}</strong> away for <strong>Free Shipping</strong>`;
        } else if (totalPrice < DISCOUNT_1_THRESHOLD) {
          const diff = DISCOUNT_1_THRESHOLD - totalPrice;
          rewardMsgEl.innerHTML = `Just <strong>${formatMoney(diff)}</strong> away for <strong>Flat ₹70 Off</strong>`;
        } else if (totalPrice < DISCOUNT_2_THRESHOLD) {
          const diff = DISCOUNT_2_THRESHOLD - totalPrice;
          rewardMsgEl.innerHTML = `Just <strong>${formatMoney(diff)}</strong> away for <strong>Flat ₹120 Off</strong>`;
        } else {
          rewardMsgEl.innerHTML = `<strong>You have unlocked all rewards!</strong>`;
        }
      }

      // Update Checkpoint Icons Active State
      // 699
      if (totalPrice >= SHIPPING_THRESHOLD) {
        cpointEls[699].classList.add('bg-black', 'border-black');
        cpointEls[699].classList.remove('bg-white', 'border-gray-100');
        cpointEls[699].firstElementChild.classList.remove('text-gray-400');
        cpointEls[699].firstElementChild.classList.add('text-white');
      } else {
        cpointEls[699].classList.remove('bg-black', 'border-black');
        cpointEls[699].classList.add('bg-white', 'border-gray-100');
        cpointEls[699].firstElementChild.classList.add('text-gray-400');
        cpointEls[699].firstElementChild.classList.remove('text-white');
      }

      // 899
      if (totalPrice >= DISCOUNT_1_THRESHOLD) {
        cpointEls[899].classList.add('bg-black', 'border-black');
        cpointEls[899].classList.remove('bg-white', 'border-gray-100');
        cpointEls[899].firstElementChild.classList.remove('text-gray-400');
        cpointEls[899].firstElementChild.classList.add('text-white');
      } else {
        cpointEls[899].classList.remove('bg-black', 'border-black');
        cpointEls[899].classList.add('bg-white', 'border-gray-100');
        cpointEls[899].firstElementChild.classList.add('text-gray-400');
        cpointEls[899].firstElementChild.classList.remove('text-white');
      }

      // 1099
      if (totalPrice >= DISCOUNT_2_THRESHOLD) {
        cpointEls[1099].classList.add('bg-black', 'border-black');
        cpointEls[1099].classList.remove('bg-white', 'border-gray-100');
        cpointEls[1099].firstElementChild.classList.remove('text-gray-400');
        cpointEls[1099].firstElementChild.classList.add('text-white');
      } else {
        cpointEls[1099].classList.remove('bg-black', 'border-black');
        cpointEls[1099].classList.add('bg-white', 'border-gray-100');
        cpointEls[1099].firstElementChild.classList.add('text-gray-400');
        cpointEls[1099].firstElementChild.classList.remove('text-white');
      }


    };

    const renderCart = (cart) => {
      currentCartState = cart; // Update local state

      titleEl.textContent = `Your Cart (${cart.item_count} items)`;
      subtotalEl.textContent = formatMoney(cart.items_subtotal_price);
      updateRewards(cart.items_subtotal_price);

      if (!cart.items || cart.items.length === 0) {
        content.innerHTML = `
            <div class="flex flex-col items-center justify-center py-12 text-center">
                <div class="p-4 bg-gray-50 rounded-full mb-4">
                    {% render 'icon', icon: 'cart', size: 32 %}
                </div>
                <p class="text-gray-900 font-medium mb-1">Your cart is empty</p>
                <p class="text-gray-500 text-sm mb-6">Looks like you haven't added anything yet.</p>
                <button onclick="window.CartDrawer.close()" class="btn btn-primary px-6 py-2 border border-black rounded bg-black text-white hover:bg-gray-800">
                    Continue Shopping
                </button>
            </div>`;
        return;
      }

      content.innerHTML = cart.items.map(item => `
        <div class="flex gap-4 border-b border-gray-400 h-36 first:border-t bg-white relative group" data-line-item-key="${item.key}">
          <a href="${item.url}" class="aspect-square h-36 bg-gray-100 flex-shrink-0 overflow-hidden border border-gray-200 block">
            ${item.image ? `<img src="${item.image}" alt="${item.product_title}" class="w-full h-full object-cover" />` : ''}
          </a>
          <div class="flex-1 min-w-0 flex flex-col justify-between py-3 pr-3">
            <div>
                <div class="flex justify-between items-start">
                    <a href="${item.url}" class="text-sm font-semibold text-gray-900 truncate pr-2 hover:underline block">${item.product_title}</a>
                    <div class="flex items-center gap-1">
                      <button type="button" class="text-gray-400 hover:text-red-500 transition-colors p-1" onclick="changeItemQuantity('${item.key}', 0)" title="Remove">
                          {% render 'icon', icon: 'trash', size: 14 %}
                      </button>
                    </div>
                </div>
                
                <div class="text-xs text-gray-500 truncate mb-1">
                  ${item.variant_title && item.variant_title !== 'Default Title' ? item.variant_title : ''}
                </div>
                <div class="text-sm font-bold">${formatMoney(item.original_line_price)}</div>
                
                <button type="button" class="text-[10px] uppercase font-bold tracking-wider text-gray-400 hover:text-black transition-colors mt-2 text-left" onclick="moveToWishlist('${item.key}')">
                  Move to Wishlist
                </button>
            </div>
            
            <div class="flex justify-end items-end mt-2">
                 <div class="flex items-center border border-gray-200 rounded h-8">
                    <button type="button" class="w-8 h-full flex items-center justify-center text-gray-500 hover:bg-gray-50 hover:text-black transition-colors" onclick="changeItemQuantity('${item.key}', ${item.quantity - 1})">−</button>
                    <div class="w-8 h-full flex items-center justify-center text-sm font-medium border-x border-gray-100">${item.quantity}</div>
                    <button type="button" class="w-8 h-full flex items-center justify-center text-gray-500 hover:bg-gray-50 hover:text-black transition-colors" onclick="changeItemQuantity('${item.key}', ${item.quantity + 1})">＋</button>
                 </div>
            </div>
          </div>
        </div>
      `).join('');
    };

    const fetchCart = () => {
      fetch('{{ routes.cart_url }}.js')
        .then(r => r.json())
        .then(cart => renderCart(cart))
        .catch(err => {
          console.error(err);
          content.innerHTML = '<div class="text-sm text-red-500 p-4 text-center">Failed to load cart. Please try refreshing.</div>';
        });
    };

    // Optimistic Update Helper
    window.changeItemQuantity = (key, newQty) => {
      if (!currentCartState) return;

      // 1. Optimistic Updates
      // Deep copy state to avoid mutating original source of truth prematurely
      const optimisticCart = JSON.parse(JSON.stringify(currentCartState));
      const itemIndex = optimisticCart.items.findIndex(item => item.key === key);

      if (itemIndex > -1) {
        const item = optimisticCart.items[itemIndex];
        const oldQty = item.quantity;
        const pricePerItem = item.final_price; // use final_price

        // Update item
        if (newQty <= 0) {
          optimisticCart.items.splice(itemIndex, 1);
          optimisticCart.item_count -= oldQty;
          optimisticCart.items_subtotal_price -= (pricePerItem * oldQty);
        } else {
          const diff = newQty - oldQty;
          item.quantity = newQty;
          item.original_line_price = pricePerItem * newQty;
          item.final_line_price = pricePerItem * newQty;
          item.line_price = pricePerItem * newQty;

          optimisticCart.item_count += diff;
          optimisticCart.items_subtotal_price += (pricePerItem * diff);
        }
        // Recalculate total price same as subtotal for simplicity in loose mode
        optimisticCart.total_price = optimisticCart.items_subtotal_price;

        // Render immediately
        renderCart(optimisticCart);
      }

      // 2. Network Request
      fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: key, quantity: newQty })
      })
        .then(r => r.json())
        .then(cart => {
          // Check for error response
          if (cart.status) {
            console.error(cart);
            if (cart.description && window.Toast) {
              window.Toast.show({ title: 'Update Failed', description: cart.description }, { type: 'error' });
            } else if (cart.description) {
              alert(cart.description);
            }
            fetchCart(); // Revert to server state
            return;
          }

          // 3. Confirm with Server Source of Truth
          renderCart(cart);
          // also update cart bubble if exists
          const bubbles = document.querySelectorAll('.cart-count-bubble');
          bubbles.forEach(el => el.textContent = cart.item_count);
        })
        .catch(err => {
          console.error('Cart update failed', err);
          // 4. Revert on failure
          // Assuming fetchCart will restore truth, or we could keep a 'previousCartState'
          fetchCart();
        });
    };

    // Helper to add cross-sell item
    window.addToCartFromForm = (form) => {
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = '...';
      submitBtn.disabled = true;

      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(item => {
          submitBtn.textContent = 'Added';
          setTimeout(() => {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
          }, 2000);
          fetchCart();
        })
        .catch(err => {
          console.error(err);
          submitBtn.textContent = 'Error';
          submitBtn.disabled = false;
        });
    }

    // Move to Wishlist Helper
    window.moveToWishlist = (key) => {
      if (!currentCartState) return;
      const item = currentCartState.items.find(i => i.key === key);
      if (!item) return;

      // Construct product object for wishlist
      const wishlistItem = {
        id: item.id, // Use Variant ID
        variant_id: item.variant_id || item.id, // Explicitly set Variant ID
        product_id: item.product_id, // Store Product ID separate if needed
        title: item.product_title,
        price: item.price,
        image: item.image,
        url: item.url,
        handle: item.handle
      };

      // Add to wishlist
      if (window.WishlistHandler && window.WishlistHandler.toggle) {
        // WishlistHandler usually needs an element or button, but we can try to find a way or manually add.
        // Since WishlistHandler implementation isn't fully visible, we'll use a direct localStorage approach 
        // compatible with the renderWishlist function we see in this file.

        try {
          let wishlist = JSON.parse(localStorage.getItem('wishlistItems') || '[]');
          // Check if already exists (by variant_id or product_id depending on logic, renderWishlist uses id)
          // The renderWishlist uses `item.id` for remove, which seems to imply it stores objects that have an `id`.
          // Let's assume we store unique items.

          // Check for duplicates
          const exists = wishlist.some(w => w.variant_id === wishlistItem.variant_id);
          if (!exists) {
            wishlist.push(wishlistItem);
            localStorage.setItem('wishlistItems', JSON.stringify(wishlist));

            // Trigger update event
            const event = new CustomEvent('wishlist:updated');
            document.dispatchEvent(event);

            if (window.Toast) window.Toast.show({ title: 'Moved to Wishlist', description: 'Item moved from cart to wishlist.' });
          } else {
            if (window.Toast) window.Toast.show({ title: 'Already in Wishlist', description: 'Item removed from cart.' });
          }
        } catch (e) {
          console.error('Failed to move to wishlist', e);
        }
      }

      // Remove from cart
      changeItemQuantity(key, 0);
    };

    // Wishlist Rendering Logic
    const wishlistSection = document.getElementById('cart-wishlist-section');
    const wishlistContainer = document.getElementById('cart-wishlist-items');

    const renderWishlist = () => {
      try {
        const wishlist = JSON.parse(localStorage.getItem('wishlistItems') || '[]');

        if (!wishlist || wishlist.length === 0) {
          wishlistSection.classList.add('hidden');
          return;
        }

        wishlistSection.classList.remove('hidden');
        wishlistContainer.innerHTML = wishlist.map(item => `
          <div class="w-40 flex-shrink-0 bg-white rounded-lg shadow-sm border border-gray-100 overflow-hidden relative group">
             <!-- Remove Button (Custom overlay) -->
             <button type="button" class="absolute top-2 right-2 w-7 h-7 bg-white rounded-full shadow-md flex items-center justify-center text-gray-400 hover:text-black z-20 opacity-0 group-hover:opacity-100 transition-opacity duration-200" 
                     onclick="window.removeFromWishlist('${item.id}')">
               {% render 'icon', icon: 'trash', size: 14 %}
             </button>

            <a href="${item.url}" class="block h-full transition-all duration-300">
              <!-- Product Image -->
              <div class="relative overflow-hidden aspect-[1/1.25]">
                ${item.image ?
            `<img src="${item.image}" alt="${item.title}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">` :
            `<div class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-300">{% render 'icon', icon: 'image', size: 24 %}</div>`
          }
                
                <!-- Add to Cart (Bottom Right) -->
                <button type="button" 
                  class="absolute bottom-2 right-2 bg-white/50 p-2 rounded-full hover:bg-white active:bg-white transition-colors z-10"
                  onclick="event.preventDefault(); window.addWishlistItemToCart(this, '${item.variant_id || item.id}')">
                  {% render 'icon', icon: 'plus', size: 20 %}
                </button>
              </div>

              <!-- Product Info -->
              <div class="px-2 pt-3 pb-4 font-outfit">
                <h3 class="text-xs uppercase font-medium text-gray-900 group-hover:text-gray-700 transition-colors mb-0.5 line-clamp-2 min-h-[2.5em]">
                  ${item.title}
                </h3>
                <div class="flex items-center justify-between leading-[1] mt-1">
                  <div class="price-container">
                    <span class="text-sm text-gray-700">${formatMoney(item.price)}</span>
                  </div>
                </div>
              </div>
            </a>
          </div>
        `).join('');

      } catch (e) {
        console.error('Error rendering wishlist:', e);
        wishlistSection.classList.add('hidden');
      }
    };

    // Global Wishlist Helpers
    window.removeFromWishlist = (id) => {
      if (window.WishlistHandler && window.WishlistHandler.toggle) {
        // Emulate product data structure for toggle (needs ID)
        window.WishlistHandler.toggle(document.createElement('button'), { id: id });
        renderWishlist(); // Re-render after removal
      }
    };

    window.addWishlistItemToCart = (btn, variantId) => {
      const originalText = btn.textContent;
      btn.textContent = '...';
      btn.disabled = true;

      const formData = new FormData();
      formData.append('id', variantId);
      formData.append('quantity', 1);

      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(item => {
          if (item.status) { // Error
            if (window.Toast) window.Toast.show({ title: 'Error', description: item.description }, { type: 'error' });
            else alert(item.description);
            btn.textContent = 'Retry';
          } else {
            btn.textContent = 'Added';
            fetchCart(); // Update cart UI
            // Optional: Remove from wishlist after adding? User didn't specify, but usually you keep it or let user remove.
          }
        })
        .catch(e => {
          console.error(e);
          btn.textContent = 'Error';
        })
        .finally(() => {
          if (btn.textContent !== 'Added') {
            setTimeout(() => {
              btn.textContent = originalText;
              btn.disabled = false;
            }, 2000);
          }
        });
    };

    // Listen for wishlist updates from other components
    document.addEventListener('wishlist:updated', renderWishlist);

    // Global controls
    document.addEventListener('click', (e) => {
      const trigger = e.target.closest('[data-cart-open]');
      if (trigger) {
        e.preventDefault();
        localStorage.setItem('cart_open', true);
        open();
        return;
      }
      if (e.target.closest('[data-cart-close]') || e.target === overlay) {
        localStorage.removeItem('cart_open');
        e.preventDefault();
        close();
      }
    });

    if (localStorage.getItem('cart_open')) {
      open();
    }

    // Expose
    window.CartDrawer = { open, close, refresh: fetchCart };

    // Auto-open if query param exists (from redirect)
    if (window.location.search.includes('cart_open=true')) {
      const url = new URL(window.location);
      url.searchParams.delete('cart_open');
      window.history.replaceState({}, '', url);
      setTimeout(open, 500);
    }
  })();
</script>